/**
 * SNS Notifications Module
 *
 * Handles sending formatted SNS notifications with emojis and structured content.
 */

const { SNSClient, PublishCommand } = require('@aws-sdk/client-sns');

const snsClient = new SNSClient({ region: process.env.AWS_REGION || 'us-east-1' });

/**
 * Send success notification
 * @param {string} topicArn - SNS topic ARN
 * @param {string} functionArn - Lambda function ARN
 * @param {Object} metrics - Success metrics
 */
async function sendSuccessNotification(topicArn, functionArn, metrics) {
  const subject = 'âœ… AWS Service Report Generated Successfully';

  const message = `âœ… AWS Service Report Generation Complete

ğŸ“Š Report Details
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Generated: ${new Date().toISOString().replace('T', ' ').replace(/\.\d{3}Z$/, ' UTC')}
â€¢ Processing Time: ${metrics.processingTime}
â€¢ Report Size: ${metrics.reportSize}

ğŸ“ Report Locations
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Latest Report:
${metrics.latestReportPath}

Archive Report:
${metrics.archiveReportPath}

ğŸ“ˆ Data Summary
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ AWS Regions: ${metrics.regionCount}
â€¢ AWS Services: ${metrics.serviceCount}
â€¢ Service-by-Region Mappings: ${metrics.serviceMappingCount.toLocaleString()}
â€¢ Data Schema Version: ${metrics.dataSchemaVersion}
â€¢ Data Timestamp: ${metrics.dataTimestamp}

ğŸ“‚ Archive Management
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Reports Retained: ${metrics.archivedReportsRetained} (7 days)
â€¢ Reports Deleted: ${metrics.archivedReportsDeleted} (older than 7 days)

---
Generated by aws-service-report-generator
Lambda Function: ${functionArn}`;

  await publishSNS(topicArn, subject, message);
}

/**
 * Send failure notification
 * @param {string} topicArn - SNS topic ARN
 * @param {string} functionArn - Lambda function ARN
 * @param {Object} errorDetails - Error details
 */
async function sendFailureNotification(topicArn, functionArn, errorDetails) {
  const subject = 'âŒ AWS Service Report Generation Failed';

  const message = `âŒ AWS Service Report Generation Failed

âš ï¸ Error Details
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Error Type: ${errorDetails.errorType}
â€¢ Error Message: ${errorDetails.error}
â€¢ Timestamp: ${new Date().toISOString().replace('T', ' ').replace(/\.\d{3}Z$/, ' UTC')}
â€¢ Processing Time: ${errorDetails.processingTime}

ğŸ“ Source File
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Bucket: ${errorDetails.sourceBucket}
â€¢ Key: ${errorDetails.sourceKey}
â€¢ Full Path: s3://${errorDetails.sourceBucket}/${errorDetails.sourceKey}

ğŸ” Troubleshooting Steps
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Verify the source file exists in S3
2. Check aws-infrastructure-fetcher Lambda execution logs
3. Verify data fetcher completed successfully at 2 AM UTC
4. Check S3 bucket permissions
5. Review CloudWatch logs for detailed error trace

ğŸ“Š CloudWatch Logs
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Log Group: /aws/lambda/aws-service-report-generator
Search for error details in the latest log stream

---
Generated by aws-service-report-generator
Lambda Function: ${functionArn}`;

  await publishSNS(topicArn, subject, message);
}

/**
 * Send warning notification (for non-critical issues)
 * @param {string} topicArn - SNS topic ARN
 * @param {string} functionArn - Lambda function ARN
 * @param {Object} metrics - Success metrics
 * @param {string} warningMessage - Warning message
 */
async function sendWarningNotification(topicArn, functionArn, metrics, warningMessage) {
  const subject = 'âš ï¸ AWS Service Report Generated with Warnings';

  const message = `âš ï¸ AWS Service Report Generated with Warnings

âœ… Report Status
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Report was generated successfully, but some non-critical issues occurred.

ğŸ“ Report Locations
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Latest Report:
${metrics.latestReportPath}

Archive Report:
${metrics.archiveReportPath}

âš ï¸ Warning Details
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Issue: Archive retention cleanup partially failed
â€¢ Details: ${warningMessage}
â€¢ Impact: Low - Manual cleanup may be needed eventually
â€¢ Timestamp: ${new Date().toISOString().replace('T', ' ').replace(/\.\d{3}Z$/, ' UTC')}

ğŸ“ˆ Data Summary
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ AWS Regions: ${metrics.regionCount}
â€¢ AWS Services: ${metrics.serviceCount}
â€¢ Processing Time: ${metrics.processingTime}
â€¢ Report Size: ${metrics.reportSize}

---
Generated by aws-service-report-generator
Lambda Function: ${functionArn}`;

  await publishSNS(topicArn, subject, message);
}

/**
 * Publish message to SNS topic
 * @param {string} topicArn - SNS topic ARN
 * @param {string} subject - Message subject
 * @param {string} message - Message body
 */
async function publishSNS(topicArn, subject, message) {
  try {
    const command = new PublishCommand({
      TopicArn: topicArn,
      Subject: subject,
      Message: message
    });

    const response = await snsClient.send(command);
    console.log(`ğŸ“§ SNS notification sent: ${response.MessageId}`);
  } catch (error) {
    console.error('âŒ Failed to send SNS notification:', error);
    throw new Error(`SNS notification failed: ${error.message}`);
  }
}

module.exports = {
  sendSuccessNotification,
  sendFailureNotification,
  sendWarningNotification
};
